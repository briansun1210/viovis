<!DOCTYPE html>
<html lang="en">
	<head>
        <link rel="stylesheet" href="../css/US_map.css" />
		<meta charset="utf-8">
		<title>D3: Stack layout stacked bar chart</title>
        
		<script type="text/javascript" src="https://d3js.org/d3.v6.min.js"></script>
		<style type="text/css">    
		</style>
	</head>
	<body classname = 'LineGraph'> 
		<script type="text/javascript">



            d3.csv("../data/policekillings.csv")
			.then(function(csv) {
                

				var data_obj = Array.from(csv, x => ({ race: x["Victim's race"],
                                                        city: x["City"],
                                                        state: x["State"]					
				}));
                

                var state_obj = {}
                var state_obj2 = {}
                data_obj.forEach((i) => {
                    
                    if (!state_obj[i.state]){
                        var bTotal = data_obj.filter(function(d, j) { return (d.race === "Black" && d.city === i.city); }).length;
                        var aTotal = data_obj.filter(function(d, j) { return (d.city === i.city); }).length;
                        state_obj[i.state] = [{city: i.city, bKill: bTotal, allKill: aTotal}]
                    }
                    else {
                        if (state_obj[i.state].filter(a => a.city === i.city).length === 0){
                            var bTotal = data_obj.filter(function(d, j) { return (d.race === "Black" && d.city === i.city); }).length;
                            var aTotal = data_obj.filter(function(d, j) { return (d.city === i.city); }).length;
                            state_obj[i.state].push({city: i.city, bKill: bTotal, allKill: aTotal - bTotal})
                        }
                    }
                    
                });

                state_obj2 = state_obj;
                


                for (var i in state_obj) {
                    state_obj[i].sort((a, b) => {
                        return b.bKill - a.bKill;
                    });
                    state_obj[i] = state_obj[i].slice(0,10)
                }

                
                for (var i in state_obj2) {
                    state_obj[i].sort((a, b) => {
                        return b.allKill - a.allKill;
                    });
                    state_obj2[i] = state_obj2[i].slice(0,10)
                }

                // console.log(state_obj["MA"])
                var range = state_obj2["MA"][0].allKill
                var range2 = state_obj2["MA"][0].bKill
                var range3 = range + range2
                var city = []

                for (var i in state_obj["MA"]){
                    city.push(state_obj2["MA"][i].city)
                }
                console.log(city)
                








                d3.select("body").append("svg").attr("width", 550).attr("height", 500)

                // var xScale = d3.scaleLinear().domain([0,10]).range([20,480])
                var xScale = d3.scaleLinear().domain(city).range([20,480])

                var yScale = d3.scaleLinear().domain([0,range3 ]).range([480,20])
                var heightScale = d3.scaleLinear().domain([0,range3]).range([20, 480])

                var kill = ["bKill", "allKill"]
                var colorScale = d3.scaleOrdinal().domain(kill).range(["#fcd88a", "#cf7c1c"])

                yAxis = d3.axisLeft().scale(yScale)
                        .tickSize(-500)

                d3.select("svg").append("g")
                    .attr("class", "yAxis")
                    .call(yAxis)
                    .attr("transform",`translate(${20}, 0)`)
                
                xAxis = d3.axisBottom()
                    .scale(xScale)
                    .tickSize(-500)   
                
                d3.select("svg").append("g")
                    .attr("class", "xAxis")
                    .call(xAxis)
                    .attr("transform",`translate(0, ${480})`)

                // d3.select("g.xAxis").selectAll("g.tick").selectAll("text")

                // d3.select("g.xAxis").selectAll("g.tick").selectAll("line")

                var stackLayout = d3.stack()
                    .keys(kill)
                
                d3.select("svg").selectAll("g.bar")
                    .data(stackLayout(state_obj["MA"])) // Pass the sorted data in
                    .enter()
                    .append("g")
                    .attr("class", "bar")
                    .each(function(d) {
                d3.select(this).selectAll("rect") 
                    .data(d)
                    .enter()
                    .append("rect")
                    .attr("width", 40)
                    .attr("height", p => heightScale(p[1]) - heightScale(p[0]))
                    .attr("x", (p, i) => xScale(i) + 25)
                    .attr("y", p => yScale(p[1]))
                    .style("fill", colorScale(d.key))
                })

            });
               
                        
				
										
		</script>
	</body>
</html>